---
title: "TR3 P2"
format: html
editor: visual
---


```{r}
library(copula)
library(MASS)
library(tseries)
library(dplyr)
library(plotly)
library(VineCopula)
```


## (a) Read in the data. Then, plot the raw prices (Adj.Close) of both stocks. Discuss the stationarity assumption. 

```{r}
engie <- read.csv("engie.csv")
veolia <- read.csv("veolia.csv")

# Data cleaning and plot
engie <- engie[-c(4456, 4489), ]
veolia <- veolia[-c(4456, 4489), ]

engie$Adj.Close <- as.numeric(engie$Adj.Close)
veolia$Adj.Close <- as.numeric(veolia$Adj.Close)

par(mfrow = c(1,2))
plot(engie$Adj.Close)
plot(veolia$Adj.Close)

# ADF test to asses the stationarity
adf_engie <- adf.test(engie$Adj.Close) #p-value = 0.4466
adf_veolia <- adf.test(veolia$Adj.Close)#p-value = 0.8228

```

Since our p value is higher that 0.05 for both data sets, we cannot reject the null hypothesis of the non-stationarity of the time series.

## (b) First, compute and plot the negative log returns in independent plots. Discuss the dates of occurrence of extreme events. Then, produce a scatterplot of the negative log returns of both stocks and discuss their (visual) dependence.

```{r}
# Create log return function
calculate_log_returns <- function(stocks) {
  log_returns <- -diff(log(stocks))
  return(log_returns)
}

# Calculate negative log returns for each index
log_returns_engie <- calculate_log_returns(engie$Adj.Close) 
plot(log_returns_engie)

log_returns_veolia <- calculate_log_returns(veolia$Adj.Close) 
plot(log_returns_veolia)

plot_engie <- plot_ly(x = engie$Date, y = engie$Adj.Close, type = "scatter", mode = "point", name = "Engie") %>%
  layout(title = "Engie")

plot_veolia <- plot_ly(x = veolia$Date, y = veolia$Adj.Close, type = "scatter", mode = "point", name = "Veolia") %>%
  layout(title = "Veolia")

combined_plot_2 <- subplot(plot_engie, plot_veolia)

layout(combined_plot_2, title = "Comparison of stock indices")

df_log_returns <- data.frame(log_returns_engie, log_returns_veolia)
```
At first sight, we see that the log returns of the indices for both companies follow a similar trend, the extremes happened at more or less same periods and the volatility is very high. The extreme events happened in 2008 (subprime crisis), 2012-2013 (european energy crisis), 2020 (COVID-19), and 2022 (Energy crisis).


```{r}
# Drawing a scatter plot
par(pty="s")
scatter.smooth(x = log_returns_engie, y = log_returns_veolia, xlab = "Engie negative log returns", ylab = "Veolia negative log returns")
```
Our scatter plot shows a strong dependance between the negative log returns. No heavy tails displayed, and the shape is close to eliptical.

## (c) Plot the pseudo-samples obtained from estimating the marginal distributions by their empirical CDFs.
```{r}

# We compute and show the CDF for both negative log returns 
cdf_engie <- ecdf(log_returns_engie)
cdf_veolia <- ecdf(log_returns_veolia)

plot(cdf_engie, col = "red", main = "Empirical Cumulative Distributions")
lines(cdf_veolia, col ="blue")

legend("bottomright", legend = c("Engie", "Veolia"), col = c("red", "blue"), lty = 1)

# Probabilities for cdf_engie and cdf_veoila
u1 <- pobs(log_returns_engie)
u2 <- pobs(log_returns_veolia)
data <- data.frame(engie_prob = u1, veolia_prob = u2)
data_matrix <- as.matrix(data)

pairs.panels(data, method = "kendall")

```

We can see that both empirical cumulative distribution functions are very similar for both Veolia and Engie. The Kendall method plot shows us a correlation coefficient of 0.42, indicating a fairly high correlation


## (d) Fit a Gaussian, a t, a Gumbel and a Clayton copula to the data. Select the copula model using an information criterion, such as the AIC.
```{r}
# Fit Gaussian copula
gaussian_copula <- normalCopula(dim = 2)
fit_gaussian <- fitCopula(gaussian_copula, data, method = "mpl")

# Fit t copula
t_copula <- tCopula(dim = 2, df = 3)
fit_t <- fitCopula(t_copula, data, method = "mpl")

# Fit Gumbel copula
gumbel_copula <- gumbelCopula(dim = 2)
fit_gumbel <- fitCopula(gumbel_copula, data, method = "mpl")

# Fit Clayton copula
clayton_copula <- claytonCopula(dim = 2, param = 2)   
fit_clayton <- fitCopula(clayton_copula, data, method = "mpl")

# Calculate AIC values
aic_values <- AIC(fit_gaussian, fit_t, fit_gumbel, fit_clayton)
aic_values
min(aic_values$AIC) ###the t distribution fits the best our data


BiCopSelect(data[,1], data[,2], familyset=NA)
```

From the AIC results, we can conclude that the t copula is the best one for our data.

## (e) Compute the theoretical tail dependence coefficients for the copulae fitted in (d), using the parameters obtained above.

```{r}
#Compute the tail dependence parameters through BiCopPar2TailDep and lambda functions
BiCopPar2TailDep(family = 2, par = fit_t@copula@parameters[1], par2 = fit_t@copula@parameters[2])

```

We obtain a lower and upper tail dependence of approximately 0.327 for both, which makes sense since the chosen copula is a t-copula (symetric distribution). This indicates that there is a positive correlation between the extreme values of Engie and Veolia.

## (f) Compute the non-parametric estimators of the tail dependence coefficients obtained from the data. Are these estimates close to the theoretical ones obtained with the best model selected in (d)?

```{r}

lambda(fit_t@copula)
fitLambda(data_matrix, method = "t", lower.tail = F)

chiplot(df_log_returns)
```

From the results of the fitLambda, we can observe very similar results to the t-copulae. To ensure these results, we drew a chi plot, which graphically seems to confirm these results. From this information, and the previously done work, we can conclude that there is a positive dependance between the extreme events of Engie and Veolia's stocks.


