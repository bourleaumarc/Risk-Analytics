---
title: "TP3_RA"
output: html_document
date: "2023-11-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
source(here::here("script/setup.R"))
```

(a) Read in the data and select only the winter temperature data. You can use the code lines of the file GetData.R to get the data and select only the winter values.
```{r}
# You may use the follwoing packages for EVT analysis
library(extRemes)
library(ismev)

##### Download daily NAO measurements
library(data.table)
NAO.daily <- 
  fread('ftp://ftp.cdc.noaa.gov/Public/gbates/teleconn/nao.reanalysis.t10trunc.1948-present.txt')
NAO.daily <- as.matrix(NAO.daily)
colnames(NAO.daily) <- c("year","month","day","NAO")

##### Download temperature data: be sure to work in the correct directory
months <- c(12,1,2) #keep only winter observations

library(readr)
temp_max_Zermatt <- read_delim("daily_maximum_Zermatt/order_107669_data.txt", 
                                         ";", escape_double = FALSE, col_types = 
                                           cols(time = col_number()), 
                                         trim_ws = TRUE, skip = 1)

colnames(temp_max_Zermatt) <- c("station","time","temp")
temp_max_Zermatt           <- temp_max_Zermatt[-1,]
temp_max_Zermatt[,2]       <- as.Date(apply(temp_max_Zermatt[,2],1,as.character),
                                      "%Y%m%d")

temp_max_Montana <- read_delim("daily_maximum_Montana/order_107668_data.txt", ";", escape_double = FALSE, col_types = cols(time = col_number()), trim_ws = TRUE, skip = 1)

colnames(temp_max_Montana) <- c("station","time","temp")
temp_max_Montana           <- temp_max_Montana[-1,]
temp_max_Montana[,2]       <- as.Date(apply(temp_max_Montana[,2],1,as.character),
                                      "%Y%m%d")

###match the dates of the two time series
temp_max_Montana           <- temp_max_Montana[match(as.matrix(temp_max_Zermatt[,2]),
                                                     as.matrix(temp_max_Montana[,2])),]
temp_max_Montana           <- as.matrix(temp_max_Montana)
colnames(temp_max_Montana) <- c("station","time","temp")
temp_max_Zermatt           <- as.matrix(temp_max_Zermatt)
colnames(temp_max_Zermatt) <- c("station","time","temp")

###keep only winter dates
library(lubridate)
temp_max_Montana <- temp_max_Montana[which(month(as.POSIXlt(temp_max_Montana[,"time"], 
                                                            format="%Y-%m-%d")) %in% months),]
temp_max_Zermatt <- temp_max_Zermatt[which(month(as.POSIXlt(temp_max_Zermatt[,"time"], 
                                                            format="%Y-%m-%d")) %in% months),]


Date       <- function( length = 0 ){
  newDate = numeric( length )
  class(newDate) = "Date"
  return(newDate)
}

season_day                   <- yday(as.Date(temp_max_Montana[,2]))
season_day[season_day < 61]  <- season_day[season_day < 61] + 31
season_day[season_day > 334] <- season_day[season_day > 334]- 334

NAO.date <- Date(nrow(NAO.daily))
for(i in 1:nrow(NAO.daily)){
  NAO.date[i] <- as.Date(paste(as.character(NAO.daily[i,1]),"-",as.character(NAO.daily[i,2]),
                               "-",as.character(NAO.daily[i,3]),sep=""),format="%Y-%m-%d")
}
nao  <- NAO.daily[intersect(as.Date(temp_max_Montana[,2]),as.Date(NAO.date)),4]


#Montana
x_Montana          <- data.frame("time"=temp_max_Montana[,2],
                                 "nao"=nao,
                                 "d"=season_day,
                                 "temp"=temp_max_Montana[,3])

as.numeric.factor  <- function(x) {as.numeric(levels(x))[x]}
x_Montana[,"temp"] <- as.numeric(x_Montana[,"temp"])
x_Montana[,"time"] <- as.numeric(year(as.POSIXlt(x_Montana[,"time"], format="%Y-%m-%d")))
x_Montana[,"time"] <- (x_Montana[,"time"]-min(x_Montana[,"time"]))/(max(x_Montana[,"time"])-
                                                                      min(x_Montana[,"time"]))

#Zermatt
x_Zermatt          <- data.frame("time"=temp_max_Zermatt[,2],
                                 "nao"=nao,
                                 "d"=season_day,
                                 "temp"=temp_max_Zermatt[,3])

as.numeric.factor  <- function(x) {as.numeric(levels(x))[x]}
x_Zermatt[,"temp"] <- as.numeric(x_Zermatt[,"temp"])
x_Zermatt[,"time"] <- as.numeric(year(as.POSIXlt(x_Zermatt[,"time"], format="%Y-%m-%d")))
x_Zermatt[,"time"] <- (x_Zermatt[,"time"]-min(x_Zermatt[,"time"]))/(max(x_Zermatt[,"time"])-
                                                                      min(x_Zermatt[,"time"]))

Z <- data.frame("Montana"=x_Montana[,"temp"] , "Zermatt"=x_Zermatt[,"temp"], "NAO"=x_Zermatt[,"nao"])
```


(b) Represent the data and especially scatterplots of Zermatt values against Montana’s values. Same with Montana values against NAO values. Comment.

```{r}
# Scatterplot of Zermatt values against Montana values
plot(Z$Montana, Z$Zermatt, xlab = "Montana Temperature", ylab = "Zermatt Temperature", 
     main = "Zermatt vs Montana Temperatures")
abline(lm(Z$Zermatt ~ Z$Montana), col = "red") # Add a linear regression line

# Scatterplot of Montana values against NAO values
plot(Z$Montana, Z$NAO, xlab = "Montana Temperature", ylab = "NAO Index", 
     main = "Montana Temperature vs NAO Index")
abline(lm(Z$NAO ~ Z$Montana), col = "blue") # Add a linear regression line

```
1) Zermatt vs Montana Temperatures:
The points in the scatterplot form a clear trend, it suggests a relationship between temperatures in Zermatt and Montana. The red line represents the linear regression model fitted to the data points. It aligns well with the points, it indicates a strong linear relationship between the temperatures at the two locations.

2) Montana Temperature vs NAO Index:
This plot visualizes the relationship between Montana temperatures and the NAO index. The blue line represents the linear regression model fitted to the data points. However, the points do not form a pattern and the blue line aligns doesn't well, it suggests that there is no relationship between Montana temperatures and the NAO index. A scattered plot might indicate a weak correlation between Montana temperatures and the NAO index.

But we have different scales and it's not the perfect graph to highlight possible correlation between the two variables.

(c) Test the correlation between these two pairs of series.

```{r}
# Correlation between Zermatt and Montana Temperatures
cor_Zermatt_Montana <- cor(Z$Zermatt, Z$Montana)
cat("Correlation between Zermatt and Montana Temperatures:", cor_Zermatt_Montana, "\n")

# Correlation between Montana Temperatures and NAO Index
cor_Montana_NAO <- cor(Z$Montana, Z$NAO)
cat("Correlation between Montana Temperatures and NAO Index:", cor_Montana_NAO, "\n")

```

Here again, we see no significant correlation between temperatures and the NAO index.

(d) Now concentrate on the extreme level and tail dependence. Represent χ and χ ̄ for two pairs of series (Montana vs Zermatt and Montana vs NAO). You may want to use the function chiplot of the package evd. What do you observe?

```{r}

library(evd)

# Create a data frame for Zermatt vs Montana Temperatures
data_Zermatt_Montana <- data.frame(Zermatt = Z$Zermatt, Montana = Z$Montana)

# Chi Plot - Zermatt vs Montana Temperatures
chiplot(data_Zermatt_Montana, main1 = "Chi Plot - Zermatt vs Montana Temperatures")

chipl
# Create a data frame for Montana Temperatures vs NAO Index
data_Montana_NAO <- data.frame(Montana = Z$Montana, NAO = Z$NAO)

# Chi Plot - Montana Temperatures vs NAO Index
chiplot(data_Montana_NAO, main1 = "Chi Plot - Montana Temperatures vs NAO Index")

```



